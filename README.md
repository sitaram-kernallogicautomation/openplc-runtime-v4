# OpenPLC Runtime v4

OpenPLC Runtime v4 designed to run programs built on OpenPLC Editor v4

## Prerequisites

### Linux

- GCC compiler
- Make
- CMake
- Python (for xml2st tool)

### Windows

- Python (required to run xml2st)
- Docker Desktop (contains GCC and Make internally)

## Run project

### Docker

1. Build image

```
   sudo bash ./scripts/build-docker-image.sh
```

2. Run image

```
   sudo bash ./scripts/run-image.sh
```

### Linux

1. Installation

```
   sudo bash ./install.sh
```

2. Start

```
   sudo bash ./start_openplc.sh
```

## Unit Tests

1. Run locally

```
   sudo bash ./scripts/setup-tests-env.sh
```

 or

2. Build development docker image

```
   sudo bash ./scripts/build-docker-image-dev.sh
```

3. Run development docker image

```
   sudo bash ./scripts/run-image-dev.sh
```

## Pre-commit setup

1. Install

```
   pip install pre-commit
   pre-commit install
```

2. Normal commit

   ```
   git add .
   git commit -m "Your commit message"  # Pre-commit checks run automatically

   ```

3. Skip pre-commit checks

   ```
   git commit --no-verify -m "Your commit message"
   ```

Use the --no-verify flag for quick fixes or when pre-commit checks aren't necessary. This bypasses all pre-commit validation for that specific commit.

## ğŸ› ï¸ Build Instructions

### Step 1: Build Application in OpenPLC IDE

1. Create your PLC program in the **OpenPLC IDE**
2. **Important**: Your project must include **Location Variables (IEC 61131-3)** to compile successfully
3. Click **Compile** in the IDE
4. This will generate a `LOCATED_VARIABLES.h` file in `{projectfolder}/build/OpenPLC Runtime/src/`

### Step 2: Generate glueVars.c with XML2ST

1. Clone and setup xml2st:

   ```bash
   git clone https://github.com/Autonomy-Logic/xml2st.git
   cd xml2st
   git switch development
   ```

2. Run xml2st with the path to your LOCATED_VARIABLES.h:

   ```bash
   xml2st --generate-gluevars /path/to/LOCATED_VARIABLES.h
   ```

3. Copy **all generated files** from `{projectfolder}/build/OpenPLC Runtime/src/` to `core/generated/` directory in this project

### Step 3: Build Runtime

#### ğŸ§ Linux Build

```bash
# Build the runtime core
mkdir build
cd build
cmake ..
make
```

#### ğŸªŸ Windows Build (Docker)

1. **Build Docker image** (run from project root):

   ```bash
   docker build -t openplc-runtime .
   ```

2. **Run Docker container** in interactive mode:

   ```bash
   docker run -it --rm -v ${PWD}:/workspace openplc-runtime bash
   ```

3. **Inside the Docker container**, build the project:

   ```bash
   mkdir build
   cd build
   cmake ..
   make
   ```

## ğŸš€ Running the Application

After successful compilation, you can run the OpenPLC Runtime:

```bash
./plc_main
```

## ğŸ“ Project Structure

```
openplc-runtime/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ src/              # Core runtime source files
â”‚   â””â”€â”€ generated/        # Generated files from OpenPLC IDE (copy here)
â”œâ”€â”€ scripts/              # Build scripts
â”œâ”€â”€ Dockerfile            # Docker configuration for Windows builds
â””â”€â”€ CMakeLists.txt        # CMake build configuration
```

## ğŸ”§ Troubleshooting

### Common Issues

- **Missing Location Variables**: Ensure your OpenPLC IDE project includes IEC 61131-3 location variables
- **Docker not found**: Install Docker Desktop on Windows
- **Build failures**: Verify all generated files are copied to `core/generated/`

### File Requirements

The `core/generated/` directory should contain:

- `glueVars.c` (generated by xml2st)
- `LOCATED_VARIABLES.h` (from OpenPLC IDE compilation)
- Other generated files from OpenPLC IDE build process
